(function(v,t,Z){function ma(){return(new Date).getTime()}function V(c){return S.call(c)==="[object Function]"}function $(c){return S.call(c)==="[object Array]"}function fa(c){return c&&S.call(c)==="[object Object]"}function qa(c){return(c||"").replace(/^\s+|\s+$/g,"")}function W(c,e){var f=false;if(fa(e)){c=c||{};for(var i in e){var j=e[i];if(c[i]!=j){f=f||{};f[i]=j}}}return f}function G(c){var e=[];if(c!=null){var f=c.length;if(f==null||typeof c==="string"||V(c)||c.setInterval)e[0]=c;else for(;f;)e[--f]=
c[f]}return e}function w(){var c=arguments[0]||{},e=1,f=arguments.length,i=false,j;if(typeof c==="boolean"){i=c;c=arguments[1]||{};e=2}if(typeof c!=="object"&&!V(c))c={};for(;e<f;e++)if((j=arguments[e])!=null)for(var l in j){var r=c[l],s=j[l];if(c!==s)if(i&&s&&typeof s==="object"&&!s.nodeType)c[l]=w(i,r||(s.length!=null?[]:{}),s);else if(s!==Z)c[l]=s}return c}function P(c,e,f){var i,j=0,l=c.length,r=l===Z||V(c);if(f)if(r)for(i in c){if(e.apply(c[i],f)===false)break}else for(;j<l;){if(e.apply(c[j++],
f)===false)break}else if(r)for(i in c){if(e.call(c[i],i,c[i])===false)break}else for(f=c[0];j<l&&e.call(f,j,f)!==false;f=c[++j]);return c}function ga(c,e){for(var f=[],i,j=0,l=c.length;j<l;j++){i=e(c[j],j);if(i!=null)f[f.length]=i}return f.concat.apply([],f)}function ra(c){var e=[];if(typeof c=="object"){for(var f in c)e[e.length]=encodeURIComponent(f)+"="+encodeURIComponent(c[f]);return e.join("&").replace(A,"+")}return c}function H(c){c=w(true,c,w(true,{},ka,c));var e,f,i=c.context||v,j=c.type.toUpperCase();
if(c.data&&c.processData&&typeof c.data!=="string")c.data=ra(c.data);if(c.cache===false&&j==="GET"){var l=ma(),r=c.url.replace(X,"$1_="+l+"$2");c.url=r+(r===c.url?(K.test(c.url)?"&":"?")+"_="+l:"")}if(c.data&&j==="GET")c.url+=(K.test(c.url)?"&":"?")+c.data;var s=false,o=c.xhr();c.username?o.open(j,c.url,c.async,c.username,c.password):o.open(j,c.url,c.async);try{c.data&&o.setRequestHeader("Content-Type",c.contentType);if(c.ifModified){ba[c.url]&&o.setRequestHeader("If-Modified-Since",ba[c.url]);ha[c.url]&&
o.setRequestHeader("If-None-Match",ha[c.url])}o.setRequestHeader("X-Requested-With","XMLHttpRequest");o.setRequestHeader("Accept",c.dataType&&c.accepts[c.dataType]?c.accepts[c.dataType]+", */*":c.accepts._default)}catch(D){}if(c.beforeSend&&c.beforeSend.call(i,o,c)===false){o.abort();return false}var L=function(aa){if(!o||o.readyState===0){if(F){clearInterval(F);F=null}}else if(!s&&o&&(o.readyState===4||aa==="timeout")){s=true;if(F){clearInterval(F);F=null}var y;if(aa==="timeout")y="timeout";else{a:{try{y=
!o.status&&location.protocol==="file:"||o.status>=200&&o.status<300||o.status===304||o.status===1223||o.status===0;break a}catch(Q){}y=false}if(y){if(y=c.ifModified){y=o;var E=c.url,J=y.getResponseHeader("Last-Modified"),na=y.getResponseHeader("Etag");if(J)ba[E]=J;if(na)ha[E]=na;y=y.status===304||y.status===0}y=y?"notmodified":"success"}else y="error";y=y}e=y;if(e==="success")try{y=o;var la=c.dataType;E=c;var ia=y.getResponseHeader("content-type"),a=la==="xml"||!la&&ia&&ia.indexOf("xml")>=0,b=a?y.responseXML:
y.responseText;if(a&&b.documentElement.nodeName==="parsererror")throw"parsererror";if(E&&E.dataFilter)b=E.dataFilter(b,la);if(typeof b==="string")if(la==="json")b=typeof Y==="object"&&Y.parse?Y.parse(b):(new Function("return "+b))();f=b}catch(d){e="parsererror"}if(e==="success"||e==="notmodified")c.success&&c.success.call(i,f,e);else if(c.error)c.error.call(c.context||v,o,e,void 0);c.complete&&c.complete.call(i,o,e);aa&&o.abort();if(c.async)o=null}};if(c.async){var F=setInterval(L,13);c.timeout>0&&
setTimeout(function(){o&&!s&&L("timeout")},c.timeout)}try{o.send(j==="POST"||j==="PUT"?c.data:null)}catch(I){if(c.error)c.error.call(c.context||v,o,null,I)}c.async||L();return o}function z(c){function e(){var J=L.document;F=F||J.getElementsByTagName("head")[0]||J.documentElement;D=J.createElement("script");D.src=c.url;if(M.async)D.async=c.async;if(c.scriptCharset)D.charset=c.scriptCharset;D.onload=D.onerror=D.onreadystatechange=function(){if(!E&&(!this.readyState||this.readyState==="loaded"||this.readyState===
"complete")){i("error");f()}};F.insertBefore(D,F.firstChild);if(!M.defaultAsync&&!M.events){J=J.createElement("script");J.appendChild(t.createTextNode("try{"+(aa?"parent.":"")+o+"()}catch(e){};"));F.insertBefore(J,F.firstChild);F=J=null}}function f(){E=true;v[s]=Z;try{delete v[s]}catch(J){}v[o]=Z;try{delete v[o]}catch(na){}D.onload=D.onreadystatechange=null;D.parentNode&&D.parentNode.removeChild(D);I&&I.parentNode&&I.parentNode.removeChild(I);D=I=F=null}function i(J){c.error&&c.error.call(r,J)}c=
w({},sa,c);var j="",l=/%20/g,r=c.context||v,s="jsonp"+oa++,o=s+"error",D,L=v,F,I,aa=c.async&&!M.fragmentProxy&&!M.defaultAsync&&!M.async;if(typeof c.data=="object"){var y=[];for(var Q in c.data)y[y.length]=encodeURIComponent(Q)+"="+encodeURIComponent(c.data[Q]);j+=y.join("&").replace(l,"+")}else j+=c.data;j=(j?j+"&":"")+(c.jsonp||"callback")+"="+(aa?"parent.":"")+s;c.url+=(/\?/.test(c.url)?"&":"?")+j;var E=false;v[s]=function(J){c.success&&c.success.call(r,J,"success");f()};v[o]=function(){if(!E){i("error");
f()}};c.timeout>0&&setTimeout(function(){if(!E){i("timeout");f();v[s]=pa}},c.timeout);if(c.async&&!M.defaultAsync&&M.fragmentProxy)F=I=t.createDocumentFragment();if(aa){j=v.location;if(c.url.slice(0,1)=="/")c.url=j.protocol+"//"+j.host+(j.port?":"+j.port:"")+c.url;else if(!/^https?:\/\//i.test(c.url)){j=j.href;l=/([^?#]+)\//.exec(j);c.url=(l?l[1]:j)+"/"+c.url}I=t.createElement("iframe");I.style.position="absolute";I.style.left="-100px";I.style.top="-100px";I.style.height="1px";I.style.width="1px";
I.style.visibility="hidden";t.body.appendChild(I);L=I.contentWindow}aa?setTimeout(function(){e()},0):e();return Z}function pa(){}function u(c,e){this._setting();this.options={jsonp:false,server:null,ticket:null,domain:null,timeout:4E4,url:{send:null}};w(this.options,e)}function T(c,e,f){if(typeof e!="undefined"){f=f||{};if(e===null){e="";f=w({},f);f.expires=-1}var i="";if(f.expires&&(typeof f.expires=="number"||f.expires.toUTCString)){if(typeof f.expires=="number"){i=new Date;i.setTime(i.getTime()+
f.expires*24*60*60*1E3)}else i=f.expires;i="; expires="+i.toUTCString()}var j=f.path?"; path="+f.path:"",l=f.domain?"; domain="+f.domain:"";f=f.secure?"; secure":"";t.cookie=[c,"=",encodeURIComponent(e),i,j,l,f].join("")}else{e=null;if(t.cookie&&t.cookie!=""){f=t.cookie.split(";");for(i=0;i<f.length;i++){j=qa(f[i]);if(j.substring(0,c.length+1)==c+"="){e=decodeURIComponent(j.substring(c.length+1));break}}}return e}}function ja(c,e){if(ca){var f=new Date,i=["[",f.getHours(),":",f.getMinutes(),":",f.getSeconds(),
"-",f.getMilliseconds(),"]"].join("");f=i+e+Y.encode(c);v.console&&v.console.log(i,e,c);i=t.getElementById("webim-log")||t.body;v.air&&v.air.trace(f);if(i){var j=t.createElement("P");j.innerHTML=f;i.appendChild(j)}}}function R(c,e){this.options=w({},R.defaults,e);this._init(c,e)}function da(c){return c&&c.split?c.split(","):$(c)?c:parseInt(c)?[parseInt(c)]:[]}function ea(c,e,f){function i(j,l){this.data=j;this.options=w({},i.defaults,l);V(this._init)&&this._init()}i.defaults=e;w(i.prototype,x,f);
R[c]=i}var S=Object.prototype.toString,x={option:function(c,e){var f=c;this.options=this.options||{};if(typeof c=="string"){if(e===Z)return this.options[c];f={};f[c]=e}w(this.options,f);return this},bind:function(c,e){var f=this._events=this._events||{};if(V(e)){f[c]=f[c]||[];f[c].push(e)}return this},trigger:function(c,e){var f=(this._events=this._events||{})[c];if(!f)return this;e=$(e)?e:G(e);for(var i=0,j=f.length;i<j;i++)f[i].apply(this,e);return this},unbind:function(c,e){var f=this._events=
this._events||{};if(!f[c])return this;if(V(e)){f=f[c];for(var i=f.length;i--;)if(f[i]===e||f[i]===e._proxy)f.splice(i,1)}else delete f[c];return this},one:function(c,e){if(!V(e))return this;var f=this,i=e._proxy=fun._proxy||function(){f.unbind(c,i);return e.apply(this,arguments)};f.bind(c,i)}},A=/%20/g,oa=ma(),K=/\?/,X=/(\?|&)_=.*?(&|$)/,ka={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return v.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):
new XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},ba={},ha={},sa={url:location.href,timeout:5E3,jsonp:"callback",async:false},M=v.jsonpSupport={async:typeof t.createElement("script").async=="boolean",events:false,defaultAsync:false,fragmentProxy:false};(function(){var c=navigator.userAgent.toLowerCase();M.events=!/(opera)(?:.*version)?[ \/]([\w.]+)/.exec(c);
M.defaultAsync=!!/(webkit)[ \/]([\w.]+)/.exec(c);c=t.createDocumentFragment();var e=t.createElement("script");text="window.jsonpSupport.fragmentProxy = true";try{e.appendChild(t.createTextNode(text))}catch(f){e.text=text}c.appendChild(e)})();var Y=function(){function c(i){return f[i]||"\\u00"+Math.floor(i.charCodeAt()/16).toString(16)+(i.charCodeAt()%16).toString(16)}function e(i){switch(Object.prototype.toString.call(i)){case "[object String]":return'"'+i.replace(/[\x00-\x1f\\"]/g,c)+'"';case "[object Array]":for(var j=
[],l=i.length,r=0;r<l;r++)j.push(e(i[r]));return"["+j.join(",")+"]";case "[object Object]":j=[];for(l in i)(r=e(i[l]))&&j.push(e(l)+":"+r);return"{"+j+"}";case "[object Number]":case "[object Boolean]":return String(i);case false:return"null"}return null}var f={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{encode:e,decode:function(i){i=i.toString();if(!i||!i.length)return null;return(new Function("return "+i))()}}}();w(u.prototype,x,{_setting:function(){this._onPolling=
this._connecting=this.connected=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},connect:function(c){var e=this;w(e.options,c);if(e._connecting)return e;e._connecting=true;c=e.options;e._onPolling||v.setTimeout(function(){e._startPolling()},300);return e},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.connected=true;this.trigger("connect","success")},_onClose:function(c){this._setting();this.trigger("close",[c])},
_onData:function(c){this.trigger("data",c)},_onError:function(c){this._setting();this.trigger("error",c)},_startPolling:function(){var c=this.options;this._onPolling=true;this._pollingTimes++;var e={url:c.server,data:{domain:c.domain,ticket:c.ticket},dataType:"json",timeout:c.timeout,cache:false,context:this,success:this._onPollSuccess,error:this._onPollError};if(c.jsonp){w(e,{timeout:c.timeout,async:true,dataType:"jsonp",jsonp:"callback"});z(e)}else H(e)},_onPollSuccess:function(c){var e=this;e._onPolling=
false;if(e._connecting)if(!c||!c.status)return e._onError("error data");else{e._pollingTimes==1&&e._onConnect();e._onData(c);e._failTimes=0;e._pollTimer=v.setTimeout(function(){e._startPolling()},200)}},_onPollError:function(c){var e=this;e._onPolling=false;if(e._connecting){e._failTimes++;if(e._pollingTimes==1)e._onError("can not connect.");else if(e._failTimes>1)e._onClose(c);else e._pollTimer=v.setTimeout(function(){e._startPolling()},200)}}});var ca=true;ja.enable=function(){ca=true};ja.disable=
function(){ca=false};w(R.prototype,x,{_init:function(){var c=this.options,e={presence:"offline",show:"unavailable"};this.request=c.jsonp?z:H;this.data={user:e};this.status=new R.status;this.setting=new R.setting(null,{jsonp:c.jsonp});this.buddy=new R.buddy(null,{active:this.status.get("b"),jsonp:c.jsonp});this.room=new R.room(null,{user:e,jsonp:c.jsonp});this.history=new R.history(null,{user:e,jsonp:c.jsonp});this.connection=new u(null,{jsonp:true});this._initEvents()},user:function(c){w(this.data.user,
c)},_ready:function(c){var e=this;e._unloadFun=v.onbeforeunload;v.onbeforeunload=function(){e._refresh()};e.trigger("ready",[c])},_go:function(){var c=this.data,e=this.history,f=this.buddy,i=this.room;e.option("userInfo",c.user);c.buddies&&P(c.buddies,function(l,r){e.init("unicast",r.id,r.history)});f.handle(c.buddies);c.rooms&&P(c.rooms,function(l,r){e.init("multicast",r.id,r.history)});f=this.setting.get("blocked_rooms");var j=c.rooms;$(f)&&j&&P(f,function(l,r){j[r]&&(j[r].blocked=true)});j&&i.handle(j);
i.options.ticket=c.connection.ticket;this.trigger("go",[c]);this.connection.connect(c.connection);if((c=c.new_messages)&&c.length){P(c,function(l,r){r["new"]=true});this.trigger("message",[c])}},_stop:function(c,e){v.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("stop",[c,e])},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function c(j){var l={id:j.from,presence:j.type};if(j.show)l.show=
j.show;if(j.nick)l.nick=j.nick;if(j.status)l.status=j.status;return l}var e=this,f=e.history,i=e.buddy;e.connection.bind("connect",function(){}).bind("data",function(j){e.handle(j)}).bind("error",function(){e._stop("connect","Connect Error")}).bind("close",function(){!e.options.disableDisconnect&&e._stop("connect","Disconnect")});e.bind("message",function(j){for(var l=[],r=j.length,s=e.data.user.id,o,D,L,F=0;F<r;F++){o=j[F];L=o.type;D=L=="unicast"?o.to==s?o.from:o.to:o.to;o.id=D;if(L=="unicast"&&
!o["new"]){D={id:D,presence:"online"};if(o.nick)D.nick=o.nick;l.push(D)}}if(l.length){i.presence(l);i.complete()}f.handle(j)});e.bind("presence",function(j){i.presence(ga(j,c))})},handle:function(c){c.messages&&c.messages.length&&this.trigger("message",[c.messages]);c.presences&&c.presences.length&&this.trigger("presence",[c.presences]);c.statuses&&c.statuses.length&&this.trigger("status",[c.statuses])},sendMsg:function(c){c.ticket=this.data.connection.ticket;this.trigger("sendMsg",[c]);this.request({type:"post",
url:this.options.urls.message,cache:false,data:c})},sendStatus:function(c){c.ticket=this.data.connection.ticket;this.request({type:"post",url:this.options.urls.status,cache:false,data:c})},sendPresence:function(c){c.ticket=this.data.connection.ticket;this.data.user.show=c.show;this.status.set("s",c.show);this.request({type:"post",url:this.options.urls.presence,cache:false,data:c})},online:function(c){var e=this,f=e.status,i=[],j=[],l=f.get("tabs"),r=f.get("tabIds");r&&r.length&&l&&P(l,function(s){s[0]==
"b"&&i.push(s.slice(2));s[0]=="r"&&j.push(s.slice(2))});c=w({buddy_ids:i.join(","),room_ids:j.join(","),show:f.get("s")||"available"},c);e._ready(c);f.set("o",false);f.set("s",c.show);e.request({type:"post",dataType:"json",data:c,url:e.options.urls.online,success:function(s){if(s)if(s.success){s.user=w(e.data.user,s.user,{presence:"online"});e.data=s;e._go()}else e._stop("online",s.error_msg);else e._stop("online","Not Found")},error:function(){e._stop("online","Not Found")}})},offline:function(){var c=
this.data;this.status.set("o",true);this.connection.close();this._stop("offline","offline");this.request({type:"post",url:this.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:c.connection.ticket}})},_refresh:function(){var c=this.data;!c||!c.connection||!c.connection.ticket||this.request({type:"post",url:this.options.urls.refresh,type:"post",cache:false,data:{ticket:c.connection.ticket}})}});v.webim=R;w(R,{version:"1.0.2",defaults:{urls:{online:"webim/online",offline:"webim/offline",
message:"webim/message",presence:"webim/presence",refresh:"webim/refresh",status:"webim/status"}},log:ja,idsArray:da,now:ma,isFunction:V,isArray:$,isObject:fa,trim:qa,makeArray:G,extend:w,each:P,inArray:function(c,e){for(var f=0,i=e.length;f<i;f++)if(e[f]===c)return f;return-1},grep:function(c,e,f){for(var i=[],j=0,l=c.length;j<l;j++)!f!==!e(c[j],j)&&i.push(c[j]);return i},map:ga,JSON:Y,ajax:H,jsonp:z,comet:u,model:ea,objectExtend:x});ea("setting",{url:"/webim/setting",data:{blocked_rooms:[],play_sound:true,
buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.request=this.options.jsonp?z:H;this.data=w({},this.options.data,this.data)},get:function(c){return this.data[c]},set:function(c,e){var f=this,i=c;if(c){if(typeof c=="string"){i={};i[c]=e}var j=f.data,l=W(j,i);if(l){P(l,function(r,s){f.trigger("update",[r,s])});i=w({},j,i);f.data=i;f.request({type:"post",url:f.options.url,dataType:"json",cache:false,data:{data:Y.encode(i)}})}}}});ea("status",{key:"_webim"},{_init:function(){var c=
this.data;if(c)this._save(c);else this.data=(c=T(this.options.key))?Y.decode(c):{}},set:function(c,e){var f=c;if(typeof c=="string"){f={};f[c]=e}var i=this.data;W(i,f)&&this._save(w({},i,f))},get:function(c){return this.data[c]},clear:function(){this._save({})},_save:function(c){this.data=c;T(this.options.key,Y.encode(c),{path:"/",domain:t.domain})}});ea("buddy",{url:"/webim/buddy"},{_init:function(){this.request=this.options.jsonp?z:H;this.data=this.data||[];this.dataHash={};this.handle(this.data)},
clear:function(){this.data=[];this.dataHash={}},count:function(c){var e=this.dataHash,f=0,i;for(var j in e)if(fa(c)){i=true;for(var l in c)if(c[l]!=e[j][l])i=false;i&&f++}else f++;return f},get:function(c){return this.dataHash[c]},complete:function(){var c=this.dataHash,e=[],f;for(var i in c){f=c[i];if(f.incomplete&&f.presence=="online"){f.incomplete=false;e.push(i)}}this.load(e)},update:function(c){this.load(c)},presence:function(c){var e=this.dataHash;c=$(c)?c:[c];for(var f in c){var i=c[f];i.presence=
i.presence=="offline"?"offline":"online";i.incomplete=!e[i.id]}this.handle(c)},load:function(c){c=da(c);c.length&&this.request({type:"get",url:this.options.url,async:true,cache:false,dataType:"json",data:{ids:c.join(",")},context:this,success:this.handle})},handle:function(c){var e=this.data,f=this.dataHash,i={};c=c||[];var j,l;for(var r in c){j=c[r];if(id=j.id){if(!f[id]){j.presence=j.presence||"online";j.show=j.show?j.show:j.presence=="offline"?"unavailable":"available";f[id]={};e.push(f[id])}j.incomplete=
!!j.incomplete;if(l=W(f[id],j)){j=l.presence||"update";i[j]=i[j]||[];w(f[id],l);i[j].push(f[id])}}}for(var s in i)this.trigger(s,[i[s]]);this.options.active&&this.complete()}});(function(){ea("room",{urls:{join:"/webim/join",leave:"/webim/leave",member:"/webim/members"}},{_init:function(){this.data=this.data||[];this.dataHash={};this.request=this.options.jsonp?z:H},get:function(c){return this.dataHash[c]},block:function(c){var e=this.dataHash[c];if(e&&!e.blocked){e.blocked=true;var f=[];P(this.dataHash,
function(i,j){j.blocked&&f.push(j.id)});this.trigger("block",[c,f])}},unblock:function(c){var e=this.dataHash[c];if(e&&e.blocked){e.blocked=false;var f=[];P(this.dataHash,function(i,j){j.blocked&&f.push(j.id)});this.trigger("unblock",[c,f])}},handle:function(c){var e=this,f=e.data,i=e.dataHash;P(c,function(j,l){var r=l.id;if(r){l.members=l.members||[];l.count=l.count||0;l.all_count=l.all_count||0;if(i[r])w(i[r],l);else{i[r]=l;f.push(l)}e.trigger("join",[i[r]])}})},addMember:function(c,e){var f=this;
if($(e))P(e,function(s,o){f.addMember(c,o)});else{var i=f.dataHash[c];if(i){for(var j=i.members,l,r=j.length;r--;)if(j[r].id==e.id)l=j[r];if(!l){e.nick=e.nick;j.push(e);i.count=j.length;f.trigger("addMember",[c,e])}}}},removeMember:function(c,e){var f=this.dataHash[c];if(f){for(var i=f.members,j,l=i.length;l--;)if(i[l].id==e){j=i[l];i.splice(l,1);f.count--}j&&self.trigger("removeMember",[c,j])}},initMember:function(c){var e=this.dataHash[c];if(e&&!e.initMember){e.initMember=true;this.loadMember(c)}},
loadMember:function(c){var e=this,f=e.options;e.request({type:"get",async:true,cache:false,url:f.urls.member,dataType:"json",data:{ticket:f.ticket,id:c},success:function(i){e.addMember(c,i)}})},join:function(c){var e=this,f=e.options;e.request({cache:false,type:"post",async:true,url:f.urls.join,dataType:"json",data:{ticket:f.ticket,id:c,nick:f.user.nick},success:function(i){e.initMember(c);e.handle([i])}})},leave:function(c){var e=this.options,f=this.dataHash[c],i=e.user;if(f){f.initMember=false;
this.request({cache:false,type:"post",url:e.urls.leave,data:{ticket:e.ticket,id:c,nick:i.nick}});this.trigger("leave",[f])}},clear:function(){}})})();ea("history",{urls:{load:"webim/history",clear:"webim/clear_history",download:"webim/download_history"}},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{};this.request=this.options.jsonp?z:H},unicast:function(c){return this.data.unicast[c]},multicast:function(c){return this.data.multicast[c]},
handle:function(c){var e=this.data,f={unicast:{},multicast:{}};c=G(c);var i=c.length,j,l,r=this.options.userInfo.id;if(i){for(var s=0;s<i;s++){j=c[s];o=j.type;if((l=o=="unicast"?j.to==r?j.from:j.to:j.to)&&o){f[o][l]=f[o][l]||[];f[o][l].push(j)}}for(var o in f)for(l in f[o]){j=f[o][l];if(e[o][l]){e[o][l]=e[o][l].concat(j);this._triggerMsg(o,l,j)}else this.load(o,l)}}},_triggerMsg:function(c,e,f){this.trigger(c,[e,f])},clear:function(c,e){var f=this.options;this.data[c][e]=[];this.trigger("clear",[c,
e]);this.request({url:f.urls.clear,type:"post",cache:false,data:{type:c,id:e}})},download:function(c,e){var f=this.options.urls.download;(new Date).getTime();var i=t.createElement("iframe"),j=new Date,l=[];j={id:e,type:c,time:(new Date).getTime(),date:j.getFullYear()+"-"+(j.getMonth()+1)+"-"+j.getDate()};for(var r in j)l[l.length]=encodeURIComponent(r)+"="+encodeURIComponent(j[r]);f+=(/\?/.test(f)?"&":"?")+l.join("&");i.setAttribute("src",f);i.style.display="none";t.body.appendChild(i)},init:function(c,
e,f){if($(f)){this.data[c][e]=f;this._triggerMsg(c,e,f)}},load:function(c,e){var f=this,i=f.options;f.data[c][e]=[];f.request({url:i.urls.load,async:true,cache:false,type:"get",dataType:"json",data:{type:c,id:e},success:function(j){f.init(c,e,j)}})}})})(window,document);
(function(v,t,Z){function ma(){return false}function V(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function $(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function fa(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function qa(a,b){for(var d=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&d.push(a);return d}function W(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function G(a,b){if(a)W(a,b)||(a.className+=" "+b)}function w(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function P(a,b,d){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+d)}function ga(a,b,d){u(a,"mouseover",function(){G(this,b);d&&w(this,d)});u(a,"mouseout",function(){w(this,
b);d&&G(this,d)})}function ra(a,b,d){if(typeof d==="boolean")d?G(a,b):w(a,b);else W(a,b)?w(a,b):G(a,b)}function H(a){a&&a.style&&(a.style.display="block")}function z(a){a&&a.style&&(a.style.display="none")}function pa(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function u(a,b,d){if(a.addEventListener)a.addEventListener(b,d,false);else{a["e"+b+d]=d;a[b+d]=function(){return a["e"+b+d](v.event)};a.attachEvent("on"+b,a[b+d])}}function T(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=
false}}function ja(a){if(!a.target)a.target=a.srcElement||t;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function R(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";u(a,"selectstart",ma)}function da(){if(!s){s=true;if(o){for(var a,b=0;a=o[b++];)a();o=null}}}function ea(){if(!D){D=true;if(t.readyState==="complete")return da();if(t.addEventListener)t.addEventListener("DOMContentLoaded",function(){t.removeEventListener("DOMContentLoaded",arguments.callee,false);
da()},false);else if(t.attachEvent){t.attachEvent("onreadystatechange",function(){if(t.readyState==="complete"){t.detachEvent("onreadystatechange",arguments.callee);da()}});t.documentElement.doScroll&&v==v.top&&function(){if(!s){try{t.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}da()}}()}u(v,"load",da)}}function S(a){var b=new Date;b.setTime(a?parseFloat(a)+S.timeSkew:(new Date).getTime());this.date=b}function x(a,b,d){d=f({locale:x.locale},d);d=x.dictionary[d.locale];
ca(d)||(d={});a=d[a]===Z?a:d[a];if(b){I=b;a=a.replace(/\{\{(.*?)\}\}/g,aa)}return a}function A(a,b){this.element=a;this.options=f({},A.defaults,b);this._init()}function oa(a){a=a.getElementsByTagName("*");for(var b,d,g={},h=a.length-1;h>-1;h--){b=a[h];if((d=b.id)&&d.indexOf(":")==0)g[d.substring(1,d.length)]=b}return g}function K(a){var b=t.createElement("div");b.innerHTML=a;return b=b.firstChild}function X(a,b,d){function g(h,k){this.id=J++;this.name=a;this.className="webim-"+a;this.options=f({},
g.defaults,k);if(this.element=h||this.template&&K(this.template())||this.options.template&&K(Q(this.options.template))){this.options.className&&G(this.element,this.options.className);this.$=oa(this.element)}M(this._init)&&this._init();M(this._initEvents)&&this._initEvents()}g.defaults=b;f(g.prototype,l,X.prototype,d);A[a]=g}function ka(a,b){A.apps[a]=b||{}}function ba(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}function ha(){t.selection&&(this.caretPos=t.selection.createRange())}
var sa=webim.idsArray,M=webim.isFunction,Y=webim.isArray,ca=webim.isObject,c=webim.trim,e=webim.makeArray,f=webim.extend,i=webim.each,j=webim.grep,l=webim.objectExtend,r=webim.map,s=false,o=[],D=false;S.timeSkew=0;S.init=function(a){S.timeSkew=(new Date).getTime()-parseFloat(a)};f(S.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);
a=a.getTime()-b.getTime();if(a<=0)return x("dt:today");else if(a<864E5)return x("dt:yesterday")}return x("dt:monthdate",{month:x(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var L=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(d){f(b,d);d=b.lib+"?_"+(new Date).getTime();
d=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+d+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+d+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+d+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{t.getElementById("webim-flashlib-c").innerHTML=
d}catch(g){}},play:function(d){d=$(d)?d:b[d];if(a)try{t.getElementById("webim-flashlib").playSound(d?d:"/sound/sound.mp3")}catch(g){}}}}(),F=function(){var a=false;u(v,"focus",function(){a=false});u(v,"blur",function(){a=true});var b=t.title,d=0,g=false;return function(h,k){if(a){if(m){clearInterval(m);d=0;g=false}var m=setInterval(function(){d++;g=!g;if(d==k||!a){clearInterval(m);d=0;g=false}t.title=g?"["+h+"]"+b:b},1500)}}}(),I={},aa=function(a,b){return I[b]||""};x.locale="zh-CN";x.dictionary=
{};x.store=function(a,b){var d=x.dictionary;ca(d[a])||(d[a]={});f(d[a],b)};f(A.prototype,l,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;b=this.layout=new A.layout(null,f({chatAutoPop:a.setting.get("msg_auto_pop")},b.layoutOptions));a.setting.get("play_sound")?L.enable():L.disable();a.setting.get("minimize_layout")?
b.collapse():b.expand();this._initEvents()},addApp:function(a,b){var d=A.apps[a];if(d){var g=this,h=g.im;M(d.init)&&d.init.apply(g,[b]);M(d.ready)&&h.bind("ready",function(){d.ready.apply(g,arguments)});M(d.go)&&h.bind("go",function(){d.go.apply(g,arguments)});M(d.stop)&&h.bind("stop",function(){d.stop.apply(g,arguments)})}},initSound:function(a){L.init(a||this.options.soundUrls)},_initEvents:function(){var a=this,b=a.im,d=b.buddy,g=b.history,h=b.setting,k=a.layout,m=b.room;b.bind("ready",function(){k.changeState("ready")}).bind("go",
function(n){k.changeState("active");k.option("user",n.user);S.init(n.server_time);a._initStatus()}).bind("stop",function(n){n=="offline"&&k.removeAllChat();k.updateAllChat();k.changeState("stop")});h.bind("update",function(n,p){switch(n){case "play_sound":p?L.enable():L.disable();break;case "msg_auto_pop":k.option("chatAutoPop",p);break;case "minimize_layout":p?k.collapse():k.expand();break}});d.bind("online",function(n){k.updateChat("buddy",n)}).bind("offline",function(n){k.updateChat("buddy",n)}).bind("update",
function(n){k.updateChat("buddy",n)});m.bind("addMember",function(n,p){var q=k.chat("room",n);q&&q.addMember(p.id,p.nick,p.id==b.data.user.id)}).bind("removeMember",function(n,p){var q=k.chat("room",n);q&&q.removeMember(p.id,p.nick)});k.bind("collapse",function(){h.set("minimize_layout",true)});k.bind("expand",function(){h.set("minimize_layout",false)});k.bind("displayUpdate",function(){a._updateStatus()});b.bind("message",function(n){for(var p=false,q=n.length,B,N=b.data.user.id,O,U,C=0;C<q;C++){B=
n[C];O=B.id;type=B.type;(U=k.chat(type,O))&&U.status("");if(!U){B.type==="unicast"?a.addChat(type,O,null,null,B.nick):a.addChat(type,O);U=k.chat(type,O)}U&&h.get("msg_auto_pop")&&!k.activeTabId&&k.focusChat(O);U.window.notifyUser("information","+1");O=U.window.pos;O==-1&&k.setNextMsgNum("+1");O==1&&k.setPrevMsgNum("+1");if(B.from!=N)p=true}if(p){L.play("msg");F(x("new message"),5)}});b.bind("status",function(n){i(n,function(p,q){var B=b.data.user.id,N=q.from;if(!(B!=q.to&&B!=q.from))(B=k.chat("buddy",
N))&&B.status(q.show)})});g.bind("unicast",function(n,p){var q=k.chat("unicast",n);q&&q.history.add(p)});g.bind("multicast",function(n,p){var q=k.chat("multicast",n);q&&q.history.add(p)});g.bind("clear",function(n,p){var q=k.chat(n,p);q&&q.history.clear()})},__status:false,_initStatus:function(){var a=this,b=a.layout;if(a.__status)return b.updateAllChat();a.__status=true;var d=a.im.status,g=d.get("tabs"),h=d.get("tabIds"),k=d.get("p");d=d.get("a");h&&h.length&&g&&i(g,function(m,n){var p=m.slice(2),
q=m.slice(0,1);a.addChat(q,p,{},{isMinimize:true});b.chat(m).window.notifyUser("information",n.n)});k&&(b.prevCount=k)&&b._fitUI();d&&b.focusChat(d)},addChat:function(a,b,d,g,h){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var k=this,m=k.layout,n=k.im,p=k.im.history,q=n.buddy,B=n.room,N=k.options;if(!m.chat(a,b))if(a=="room"){d=f({},N.roomChatOptions,d);N=p.multicast(b);var O=B.get(b);h=O||{id:b,nick:h||b};h.presence="online";m.addChat(a,h,f({history:N,block:true,emot:true,clearHistory:false,
member:true,msgType:"multicast"},d),g);N||p.load("multicast",b);var U=m.chat(a,b);U.bind("sendMsg",function(C){n.sendMsg(C);p.handle(C)}).bind("downloadHistory",function(C){p.download("multicast",C.id)}).bind("select",function(C){q.presence(C);q.complete();k.addChat("buddy",C.id,null,null,C.nick);m.focusChat("buddy",C.id)}).bind("block",function(C){B.block(C.id)}).bind("unblock",function(C){B.unblock(C.id)}).window.bind("close",function(){U.options.info.blocked&&B.leave(b)});setTimeout(function(){U.options.info.blocked?
B.join(b):B.initMember(b)},500);Y(h.members)&&i(h.members,function(C,ta){U.addMember(ta.id,ta.nick,ta.id==n.data.user.id)})}else{d=f({},N.buddyChatOptions,d);N=p.unicast(b);h=(O=q.get(b))||{id:b,nick:h||b};m.addChat(a,h,f({history:N,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},d),g);O||q.update(b);N||p.load("unicast",b);m.chat(a,b).bind("sendMsg",function(C){n.sendMsg(C);p.handle(C)}).bind("sendStatus",function(C){n.sendStatus(C)}).bind("clearHistory",function(C){p.clear("unicast",
C.id)}).bind("downloadHistory",function(C){p.download("unicast",C.id)})}},_updateStatus:function(){var a=this.layout,b={};i(a.tabs,function(d,g){b[d]={n:g._count()}});this.im.status.set({tabs:b,tabIds:a.tabIds,p:a.prevCount,a:a.activeTabId})}});var y=function(a,b){if(b===Z)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();H(a)}else{a.innerHTML="0";z(a)}return b},Q=function(){function a(g,h){return b&&b[h]!=Z?b[h]:x(h)}var b=null,
d=/\<\%\=(.*?)\%\>/ig;return function(g,h){if(!g)return"";b=h;return g.replace(d,a)}}(),E={add:function(a,b,d){a=A[a].prototype;for(var g in d){a.plugins[g]=a.plugins[g]||[];a.plugins[g].push([b,d[g]])}},call:function(a,b,d){if((b=a.plugins[b])&&a.element.parentNode)for(var g=0;g<b.length;g++)a.options[b[g][0]]&&b[g][1].apply(a.element,d)}},J=1;f(X.prototype,{_init:function(){}});f(A,{version:"3.0.1",widget:X,app:ka,plugin:E,i18n:x,date:S,ready:function(a){ea();s?a():o.push(a)},createElement:K,defaults:{},
apps:{}});webim.ui=A;X("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(a)},_init:function(a,b){b=this.options;var d=this.$;a=this.element;a.window=this;b.tabWidth&&(d.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&z(d.minimize);!b.maximizable&&z(d.maximize);if(!b.closeable){z(d.tabClose);z(d.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?z(d.tabTitle):
pa(d.tabTip);b.count&&this.notifyUser("information",b.count);na(this)},notifyUser:function(a,b){var d=this.$;if(a=="information")if(this.isMinimize())if(y(d.tabCount,b)){G(d.tab,"ui-state-highlight");w(d.tab,"ui-state-default")}},_count:function(){return y(this.$.tabCount)},title:function(a,b){var d=this.$,g=d.tabIcon;if(b)if($(b)){g.className="webim-icon";g.style.backgroundImage="url("+b+")"}else g.className="webim-icon webim-icon-"+b;d.tabTipC.innerHTML=a;g=this.options.titleVisibleLength;if(a){for(var h=
0,k=[],m=a.split(""),n=m.length,p=0;p<n;p++)if(h>=g||h<0)break;else{if(m[p].charCodeAt(0)>255)h+=2;else h++;k.push(m[p])}g=k.join("")}else g=a;(d.tabTitle.innerHTML=g)&&a&&g.length<a.length&&d.tabTitle.setAttribute("title",a);d.headerTitle.innerHTML=a},_changeState:function(a){P(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return W(this.element,"webim-window-active")},
activate:function(){if(!this.active()){G(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){w(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;P(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();y(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!W(this.element,
"webim-window-normal")){this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){P(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");pa(this.element)},_initEvents:function(){var a=this,b=a.$,d=b.tab,g=function(h){if(h){h.stopPropagation&&h.stopPropagation();h.cancelBubble=true}T(h)};u(d,"click",function(h){a.isMinimize()?a.restore():a.minimize();
g(h)});u(d,"mouseover",function(){G(this,"ui-state-hover");w(this,"ui-state-default")});u(d,"mouseout",function(){w(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&G(this,"ui-state-default")});u(d,"mousedown",g);R(d);i(qa(b.actions.firstChild),function(h,k){ga(k,"ui-state-hover")});i(["minimize","maximize","close","tabClose"],function(h,k){u(b[k],"click",function(m){this.disabled||a[k]();g(m)});u(b[k],"mousedown",g)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},
isMaximize:function(){return W(this.element,"webim-window-maximize")},isMinimize:function(){return W(this.element,"webim-window-minimize")}});var na=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},d=function(){this&&this!=a&&b()&&(a=this)},g=function(){this&&a==this&&(a=false)};u(t,"mousedown",function(h){h=ja(h);for(var k;h;)if(h.id==":webim-window"){k=h;break}else h=h.parentNode;if(k)(h=k.window)&&h.activate();else b()});return function(h){if(h.active()){b();a=h}h.bind("activate",
d);h.bind("deactivate",g)}}();X("layout",{template:'<div id="webim" class="webim webim-state-ready">                    <div class="webim-preload ui-helper-hidden-accessible">                    <div id="webim-flashlib-c">                    </div>                    </div><div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">                            <div id=":shortcut" class="webim-shortcut">                            </div>                            <div class="webim-layout-r">                            <div id=":panels" class="webim-panels">                                <div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">                                            <div id=":next" class="webim-window-tab webim-panels-next ui-state-default">                                                    <div id=":nextMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em class="ui-icon ui-icon-triangle-1-w"></em>                                                    <span id=":nextCount">0</span>                                            </div>                                </div>                                <div id=":tabsWrap" class="webim-panels-tab-wrap">                                        <div id=":tabs" class="webim-panels-tab">                                        </div>                                </div>                                <div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">                                            <div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">                                                    <div id=":prevMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <span id=":prevCount">0</span>                                                    <em class="ui-icon ui-icon-triangle-1-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">                                            <div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">                                                    <em class="ui-icon ui-icon-circle-arrow-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-expand-wrap ui-widget">                                            <div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">                                                    <em class="ui-icon ui-icon-circle-arrow-w"></em>                                            </div>                                </div>                            </div>                            <div id=":widgets" class="webim-widgets">                            </div>                            </div>            </div></div>                    </div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">                                                    <div class="webim-window-tab-tip">                                                            <strong><%=title%></strong>                                                    </div>                                                    <em class="webim-icon" style="background-image:url(<%=icon%>)"></em>                                            </a>                                            </div>'},
{_init:function(a,b){b=this.options;f(this,{window:v,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,prevCount:0});b.unscalable&&G(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((t.compatMode==="CSS1Compat"&&t.documentElement.clientWidth||t.body.clientWidth)-
45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,d=this.maxVisibleTabs,g=b.length,h=this.prevCount;if(!(g<=d)){if(a){for(var k=0,m=0;m<g;m++)if(b[m]==a){k=m;break}if(k<=h)h=k;else if(k>=h+d)h=k-d+1}else h=g-d;this.prevCount=h}},_setVisibleTabs:function(a){for(var b=this.prevCount,d=b+this.maxVisibleTabs,g=this.tabs,h=this.tabIds,k=h.length,m=0,n=0,p=0;p<k;p++){var q=g[h[p]];if(p<b||p>=d)if(a)H(q.element);
else{this.activeTabId==h[p]&&q.minimize();var B=q._count();if(p<b){n+=B;q.pos=1}else{m+=B;q.pos=-1}z(q.element)}else{q.pos=0;H(q.element)}}if(!a){this.setNextMsgNum(m);this.setPrevMsgNum(n)}},setNextMsgNum:function(a){y(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){y(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,d=b.prevCount,g=b.nextCount;if(g>0&&a==-1||d>0&&a==1){b.slideing=true;if(g==1&&a==-1||d==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==
-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var h=b.$.tabs,k=parseFloat(h.style.left);d=-1*b.tabWidth*b.nextCount;var m=parseInt(500/13),n=1,p=(d-k)/m,q=setInterval(function(){h.style.left=k+p*n+"px";if(n==m){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(q)}else n++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,d=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=
null;d.style.position=a?"":"relative";d.style.overflow=a?"visible":"hidden";d.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,d=this.prevCount,g=this.nextCount;if(b<=a)d=g=0;else{g=b-a-d;g=g<0?0:g;d=b-a-g}this.prevCount=d;this.nextCount=g},_updateCountUI:function(){var a=this.$,b=this.prevCount,d=this.nextCount;
d<=0?G(a.next,"ui-state-disabled"):w(a.next,"ui-state-disabled");b<=0?G(a.prev,"ui-state-disabled"):w(a.prev,"ui-state-disabled");if(b>0||d>0){a.next.style.display="block";a.prev.style.display="block"}else{z(a.next);z(a.prev)}a.nextCount.innerHTML=d.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,d=false;u(a.window,"resize",function(){if(d){d=true;a.buildUI()}});u(b.next,"mousedown",function(){a._slide(-1)});u(b.next,"mouseup",function(){a._slideUp()});R(b.next);
u(b.prev,"mousedown",function(){a._slide(1)});u(b.prev,"mouseup",function(){a._slideUp()});R(b.prev);u(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});u(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ga(b.collapse,"ui-state-hover","ui-state-default");ga(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return W(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||
G(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&w(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&i(this.widgets,function(d,g){g.window!=a&&g.window.minimize()});this._displayUpdate()},
widget:function(a){return this.widgets[a]},addWidget:function(a,b,d,g){var h=this;b=f(b,{closeable:false,subHeader:a.header});var k=a.element;b=new A.window(null,b);b.html(k);h.$[g?g:"widgets"].insertBefore(b.element,d&&h.widgets[d]?h.widgets[d].window.element:null);a.window=b;b.bind("displayStateChange",function(m){h._widgetStateChange(this,m)});h.widgets[a.name]=a},focusChat:function(a,b){b=ba(a,b);var d=this.tabs[b],g=this.panels[b];d&&d.isMinimize()&&d.restore();g&&g.focus()},chat:function(a,
b){return this.panels[ba(a,b)]},updateChat:function(a,b){b=e(b);for(var d,g=b.length,h,k=0;k<g;k++){d=b[k];(h=this.panels[ba(a,d.id)])&&h.update(d)}},updateAllChat:function(){i(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=j(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},
_changeActive:function(a,b){var d=this.activeTabId;if(b)d==a&&(this.activeTabId=null);else{d&&d!=a&&this.tabs[d].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,d,g){var h=this,k=h.panels,m=b.id;m=ba(a,m);if(!k[m]){a=h.tabs[m]=(new A.window(null,f({isMinimize:h.activeTabId||!h.options.chatAutoPop,tabWidth:h.tabWidth-2,titleVisibleLength:9},g))).bind("close",function(){h._onChatClose(m)}).bind("displayStateChange",function(n){h._onChatChange(m,n)});h.tabIds.push(m);h.$.tabs.insertBefore(a.element,
h.$.tabs.firstChild);k[m]=new A.chat(null,f({window:a,user:h.options.user,info:b},d));!a.isMinimize()&&h._changeActive(m);h._fitUI()}},removeChat:function(a,b){var d=this.tabs[ba(a,b)];d&&d.close()},removeAllChat:function(){i(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(Y(a))i(a,function(h,k){b.addShortcut(k)});else if(ca(a)){var d=b.$.shortcut,g=b.options.tpl_shortcut;if(!(d.childNodes.length>b.options.shortcutLength+1)){g=K(Q(g,{title:x(a.title),icon:a.icon,link:a.link,
target:a.isExtlink?"_blank":""}));ga(g.firstChild,"ui-state-hover");d.appendChild(g)}}},addWindow:function(){new A.window(null,{})},online:function(){},offline:function(){}});X("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){E.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=e(a);var b=a.length,
d=[];if(b){for(var g=0;g<b;g++)d.push(this._renderMsg(a[g]));this.$.content.innerHTML+=d.join("");this.trigger("update")}},_renderMsg:function(a){a=f({},a);E.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,d=a.to,g=a.timestamp,h=a.body,k=true,m=this._lastLogItem,n=[],p;p=a.nick;if(m&&m.to==d&&m.from==b&&g-m.timestamp<6E4)k=false;if(k){this._lastLogItem=a;a=new S(g);n.push('<h4><span class="webim-gray">');n.push(a.getDay(true));n.push(" ");n.push(a.getTime());n.push("</span>");n.push(p);n.push('</h4><hr class="webim-line ui-state-default" />')}n.push("<p>");
n.push(h);n.push("</p>");return n.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,d=new Date,g=new Date,h=[];d.setTime(a);b&&g.setTime(b.timestamp);if(!b||d.getDate()!=g.getDate()||d.getMonth()!=g.getMonth()){h.push("<h5>");h.push((new S(a)).getDay(true));h.push("</h5>")}return h.join("")},ui:function(a){return f({element:this.element,$:this.$},a)},plugins:{}});var la=function(){function a(g,h){return'<a href="'+(h=="www."?"http://"+g:g)+'"'+d+">"+g+"</a>"}function b(g,h){d+=" "+g+
'="'+h+'"'}var d;return function(g,h){d="";h&&ca(h)&&i(h,b);return g.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();A.history.defaults.parseMsg=true;E.add("history","parseMsg",{render:function(a,b){var d=b.msg.body;d=V(d);d=la(d,{target:"_blank"});b.msg.body=d}});A.history.defaults.emot=true;E.add("history","emot",{render:function(a,b){b.msg.body=A.emot.parse(b.msg.body)}});X("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;i(b.firstChild.childNodes,
function(d,g){u(g,"click",function(){w(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');i(a,function(d,g){var h=g.src,k=g.t?g.t:g.q[0];b.push('<li><img src="');b.push(h);b.push('" title="');b.push(k);b.push('" alt="');b.push(g.q[0]);b.push('" rel="');b.push(g.q[0]);b.push('" /></li>')});b.push("</ul>");return Q(this.options.template,{emots:b.join("")})},toggle:function(){ra(this.element,
"webim-emot-show")}});f(A.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",
src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,d=b._q={};a=f({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var g=a.dir+"/";i(b.emots,function(h,k){if(k&&k.src)k.src=g+k.src;k&&k.q&&i(k.q,function(m,n){d[n]=h})})},
parse:function(a){var b=webim.ui.emot._q,d=webim.ui.emot.emots;b&&i(b,function(g,h){var k=d[h],m=k.src,n=k.t?k.t:k.q[0],p=[];p.push('<img src="');p.push(m);p.push('" title="');p.push(n);p.push('" alt="');p.push(k.q[0]);p.push('" />');g=V(g);g=g.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(g,"g"),p.join(""))});return a}});X("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t\t     </div></div>',
template:'<div class="webim-chat"> \t\t\t\t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},
{_init:function(){var a=this.element,b=this.options,d=this.window=b.window,g=this.history=new A.history(null,{user:b.user,info:b.info});this.$.content.insertBefore(g.element,this.$.content.firstChild);this.header=K(Q(b.tpl_header));f(this.$,oa(this.header));if(d){d.subHeader(this.header);d.html(a);this._bindWindow()}b.simple&&z(this.header);this.update(b.info);g.add(b.history);E.call(this,"init",[null,this.ui()]);this._adjustContent()},update:function(a){if(a){this.option("info",a);this.history.option("info",
a);this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(x("buddy offline notice",{name:this.options.info.nick}));else this.notice(x("user offline notice"));E.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;v.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var d=this,g=d.$.notice,h=d._noticeTime;h&&clearTimeout(h);if(a)if(b){g.innerHTML=a;H(g);setTimeout(function(){if(d._noticeTxt)g.innerHTML=
d._noticeTxt;else z(g,500)},b)}else{d._noticeTxt=a;g.innerHTML=a;H(g)}else{d._noticeTxt=null;z(g)}},_adjustContent:function(){var a=this.$.content;a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b){if(b!="minimize"){v.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var d=a.height();d>32&&d<100&&a.height(d+b)}},
_sendMsg:function(a){var b=this.options,d=b.info;a={type:b.msgType,to:d.id,from:b.user.id,nick:b.user.nick,offline:d.presence!="online",timestamp:(new Date).getTime(),body:a};E.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMsg",a)},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=ja(a),d=b.value;if(c(d).length){this._sendMsg(d);b.value="";T(a)}}else this._typing()},_onFocusInput:function(a){var b=this;ja(a);(v.getSelection?v.getSelection().toString():
t.selection?t.selection.createRange().text:"")||v.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,d=x("input notice"),g=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(x("clear history notice"),3E3)});u(g,"keyup",function(){ha.call(this)});u(g,"click",ha);u(g,"select",ha);u(g,"focus",function(){w(this,"webim-gray");if(this.value==d)this.value=""});u(g,"blur",function(){if(this.value==""){G(this,"webim-gray");this.value=
d}});u(g,"keypress",function(h){a._inputkeypress(h)});u(b.content,"click",function(h){a._onFocusInput(h)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=fa(a.status)||"&nbsp";this.window.title(a.nick,a.show)},insert:function(a,b){var d=
this.$.input;d.focus();if(b){a||(a="");if(d.setSelectionRange){var g=d.value,h=d.selectionStart,k=d.selectionEnd,m=g.substring(0,h);g=g.substring(k);k=a.length;d.value=m+a+g;d.setSelectionRange(h+k,h+k)}else if(t.selection)if(h=d.caretPos){h.text=a;h.collapse();h.select()}else d.value+=a;else d.value+=a}else d.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",{to:this.options.info.id,show:a})}},
_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=v.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,d=this.options.info.nick,g="";g=a=="clear"?"":d+x(a);b.innerHTML=g;this._adjustContent();this._setST&&clearTimeout(this._setST);if(g!="")this._setST=v.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.window.close()},ui:function(a){return f({self:this,
$:this.$,history:this.history},a)},plugins:{}});A.chat.defaults.emot=true;E.add("chat","emot",{init:function(a,b){var d=b.self,g=new A.emot;g.bind("select",function(k){d.focus();d.insert(k,true)});var h=K(Q('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));u(h,"click",function(k){T(k);g.toggle()});b.$.toolContent.appendChild(g.element);b.$.tools.appendChild(h)},send:function(){}});A.chat.defaults.clearHistory=true;E.add("chat","clearHistory",{init:function(a,
b){var d=b.self,g=K(Q('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));u(g,"click",function(h){T(h);d.trigger("clearHistory",[d.options.info])});b.$.tools.appendChild(g)}});A.chat.defaults.block=true;E.add("chat","block",{init:function(a,b){var d=b.self,g=d.options.info.blocked,h=d.options.info.nick,k=K('<a href="#chat-block" style="display:'+(g?"none":"")+'" title="'+x("block group",{name:h})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),
m=K('<a href="#chat-block" style="display:'+(g?"":"none")+'" title="'+x("unblock group",{name:h})+'"><em class="webim-icon webim-icon-block"></em></a>');u(k,"click",function(n){T(n);z(k);H(m);d.trigger("block",[d.options.info])});u(m,"click",function(n){T(n);z(m);H(k);d.trigger("unblock",[d.options.info])});b.$.tools.appendChild(k);b.$.tools.appendChild(m)}});A.chat.defaults.member=true;f(A.chat.prototype,{addMember:function(a,b,d){var g=this,h=g.memberLi;if(!h[a]){var k=K('<li><a class="'+(d?"ui-state-disabled":
"")+'" href="'+a+'">'+b+"</a></li>");u(k.firstChild,"click",function(m){T(m);d||g.trigger("select",[{id:a,nick:b}])});h[a]=k;g.$.member.appendChild(k);g.$.memberCount.innerHTML=parseInt(g.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});E.add("chat","member",{init:function(a,b){var d=b.$;b.self.memberLi={};var g=K(Q('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),
h=oa(g);d.member=h.ul;d.memberCount=h.memberCount;d.content.parentNode.insertBefore(g,d.content)}});A.chat.defaults.downloadHistory=true;E.add("chat","downloadHistory",{init:function(a,b){var d=b.self,g=K(Q('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));u(g,"click",function(h){T(h);d.trigger("downloadHistory",[d.options.info])});b.$.tools.appendChild(g)}});var ia=false;ka("buddy",{init:function(a){a=a||{};
var b=this,d=b.im,g=d.buddy,h=b.layout,k=b.buddy=new A.buddy(null,f({title:x("buddy")},a));h.addWidget(k,f({title:x("buddy"),icon:"buddy",sticky:d.setting.get("buddy_sticky"),className:"webim-buddy-window",isMinimize:!d.status.get("b"),titleVisibleLength:19},a.windowOptions));if(!a.disable_user){b.addApp("user",a.userOptions);if(a.is_login){k.window.subHeader(b.user.element);b.user._initElement=true}}!a.is_login&&!a.disable_login&&b.addApp("login",f({container:k.$.content},a.loginOptions));d.setting.bind("update",
function(q,B){q=="buddy_sticky"&&k.window.option("sticky",B)});k.bind("select",function(q){b.addChat("buddy",q.id);b.layout.focusChat("buddy",q.id)});k.window.bind("displayStateChange",function(q){if(q!="minimize"){g.option("active",true);ia&&d.status.set("b",1);g.complete()}else{ia&&d.status.set("b",0);g.option("active",false)}});var m=function(q){return ca(q)?q.id:q},n=function(q){return q.show!="invisible"&&q.presence=="online"},p=function(q){return q.show=="invisible"};g.bind("online",function(q){k.add(j(q,
n))});g.bind("offline",function(q){k.remove(r(q,m))});g.bind("update",function(q){k.add(j(q,n));k.update(j(q,n));k.remove(r(j(q,p),m))});k.offline()},ready:function(){var a=this.buddy;z(a.$.logo);a.online()},go:function(){var a=this.buddy;this.user&&!this.user._initElement&&a.window.subHeader(this.user.element);ia=true;a.titleCount();a.hideError()},stop:function(a,b){var d=this.buddy;ia=false;d.offline();if(a=="online"||a=="connect")d.showError(b)}});X("buddy",{template:'<div id="webim-buddy" class="webim-buddy">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content" id=":content">\t\t\t\t<div id=":logo" class="webim-buddy-logo">&nbsp;</div>\t\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=
this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&G(this.element,"webim-buddy-hidegroup");a.simple&&G(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,d=b.search,g=b.searchInput,h=x("search buddy");u(d.firstChild,"click",function(){g.focus()});g.value=h;u(g,"focus",function(){G(d,"ui-state-active");if(this.value==h)this.value=""});u(g,"blur",function(){w(d,"ui-state-active");if(this.value=="")this.value=h});u(g,"keyup",function(){var k=
this.value;i(a.li,function(m,n){k&&(n.text||n.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?z(n):H(n)})})},titleCount:function(){var a=this.size,b=this.window,d=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?z(d):H(d);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){ra(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=
this.window;b&&b.title(this.options.title+"["+x(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");z(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();z(a.empty);H(a.logo);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;var d=b.show?b.show:"available";a.className="webim-icon webim-icon-"+d;a.setAttribute("title",
x(d));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=fa(b.status)||"&nbsp;";return a},_addOne:function(a,b){var d=this,g=d.li,h=a.id,k=d.$.ul;if(!g[h]){d.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=fa(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=x(a.show);a.pic_url=a.pic_url||"";g=g[h]=K(Q(d.options.tpl_li,
a));u(g.firstChild,"click",function(p){T(p);d.trigger("select",[a]);this.blur()});var m=d.groups,n=x(a.group||"friend");m=m[n];if(!m){m=K(Q(d.options.tpl_group));z(m);if(n==x("stranger"))b=true;b?k.appendChild(m):k.insertBefore(m,k.firstChild);m={name:n,el:m,count:0,title:m.firstChild,li:m.lastChild};d.groups[n]=m}m.count==0&&H(m.el);d.li_group[h]=m;m.li.appendChild(g);m.count++;m.title.innerHTML=n+"("+m.count+")"}},_updateOne:function(a){var b=this.li,d=a.id;b[d]&&this._updateInfo(b[d],a)},update:function(a){a=
e(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=e(a);for(var d=0;d<a.length;d++)this._addOne(a[d],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var d in b)a.push(d);this.remove(a);this.titleCount()},remove:function(a){var b,d,g=this.li,h,k=this.li_group;a=sa(a);for(var m=0;m<a.length;m++){b=a[m];if(d=g[b]){this.size--;if(h=k[b]){h.count--;h.count==0&&z(h.el);h.title.innerHTML=h.name+"("+h.count+")"}pa(d);delete g[b]}}this.titleCount()},select:function(a){(a=
this.li[a])&&a.firstChild.click();return a},hideError:function(){z(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=x(a);H(b)},destroy:function(){}});ka("visitorstatus",{init:function(){var a=this.im,b=a.status,d=b.get("v_f"),g=b.get("v_l"),h=t.referrer,k=t.location.href,m=t.location.host;if(h&&h!=d){var n=(ex=/\/\/([^\/]+)/.exec(h))&&ex[1];if(n&&n!=m)b.set("v_f",h);else h=d}else h=d;k!=g&&b.set("v_l",k);this.visitorstatus=k+(h?" | "+x("from")+" "+h:"");var p={};a.bind("sendMsg",
function(q){var B="v_to_"+q.to;if(!p[B]){p[B]=true;var N="",O=a.status.get(B);if(!O||k!=g||h!=d){a.status.set(B,1);N=x("location")+": "+k;if(h&&(!O||h!=d))N+=" \n "+x("from")+": "+h}N&&a.sendMsg(f({},q,{body:N,"transient":true}))}})},ready:function(a){a.visitorstatus=this.visitorstatus}});ka("logmsg",{init:function(){var a=this.im;a.connection.bind("data",function(b){b=b&&b.messages;for(var d=0;d<b.length;d++){var g=b[d];g.ticket=a.data.connection.ticket;a.request({type:"post",url:a.options.urls.logmsg,
cache:false,data:g})}})}})})(window,document);
